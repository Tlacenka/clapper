#!/bin/bash

# File: 06_root.yaml
# Brief: Test nr. 6 - Basic HOT Resolution

parameters:
  # Values added via environment
  ControllerPassword:
    description: Controller password
  CinderPassword:
    description: Cinder password
  GlancePassword:
    description: Glance password
  HeatPassword:
    description: Heat password
  NovaPassword:
    description: Nova password
  SwiftPassword:
    description: Swift Password

  # Value added via environment parameter_defaults
  Hostname:
    description: hostname

  # Value determined by resource/default
  ControllerHostnameFormat:
    type: string
    description: Format for Controller node hostnames
    default: '%stackname%-controller-%index%'
  Image:
    description: Glance image
    default: overcloud-full
    constraints:
      - custom_constraint: glance.image
  KeyName:
    description: Key name
    default: guest-key

  # Example of structured parameter value
  ServiceNetMap:
    description: Mapping of service_name -> network name.
    default:
      NeutronTenantNetwork: tenant
      CinderApiNetwork: internal_api
      CinderIscsiNetwork: storage
      GlanceApiNetwork: storage
      GlanceRegistryNetwork: internal_api
      KeystoneAdminApiNetwork: ctlplane # allows undercloud to config endpoints
      KeystonePublicApiNetwork: internal_api
      NeutronApiNetwork: internal_api
      HeatApiNetwork: internal_api
      NovaApiNetwork: internal_api
      NovaMetadataNetwork: internal_api
      NovaVncProxyNetwork: internal_api
      SwiftMgmtNetwork: storage_mgmt
      SwiftProxyNetwork: storage
      ControllerHostnameResolveNetwork: internal_api
      ComputeHostnameResolveNetwork: internal_api
      BlockStorageHostnameResolveNetwork: internal_api
      ObjectStorageHostnameResolveNetwork: internal_api
    type: json
  
  # WARNING: Unused parameter
  RandomParameter:
    description: Unused parameter


resources:
  Controller:
    type: OS::Heat::ResourceGroup
    properties:
      # ERROR: Basic non-existent parameter resolution
      count: {get_param: NonExistentParameter}

      resource_def:
        type: OS::TripleO::Controller
        properties:
          # Properties with matching parameters
          ControllerPassword: {get_param: ControllerPassword}
          CinderPassword: {get_param: CinderPassword}
          GlancePassword: {get_param: GlancePassword}
          HeatPassword: {get_param: HeatPassword}
          Image: {get_param: Image}
          KeyName: {get_param: KeyName}
          NovaPassword: {get_param: NovaPassword}
          SwiftPassword: {get_param: SwiftPassword}
          ServiceNetMap: {get_param: ServiceNetMap}

          Hostname:
            str_replace:
              template: {get_param: ControllerHostnameFormat}
              params:
              #  Pseudo-parameter usage
                '%stackname%': {get_param: 'OS::stack_name'}

          # ERROR: Property without matching parameter
          ForeverAloneProperty: random-value

outputs:
  controller_network:
    value:
      # Checking valid get_attr resolution
      IPv4: {get_attr: [Controller, ip_address, IPv4, 1]}

      # ERROR: Get_attr resolution with non-existent index
      IPv6: {get_attr: [Controller, ip_address, IPv6, 1]}
  controller:
    value:
      # Valid get_attr resolution
      handler: {get_attr: [Controller, server_resource]}
