#!/bin/bash

# File: 07_root.yaml
# Brief: Test nr. 7 - Advanced HOT Resolution
#        Contains 5 HOT files and 2 environment files

# TODO: resolution across at least 3 YAML files (get_param > peroperty value is get_attr)
#       RG and ASG stuff, getting resource via all sorts of keywords
#       

parameters:

  # from env2
  ControllerCount:
    type: number

  ComputeCount:
    type: number

  # ServiceNetMap from overcloud.yaml
  ServiceNetMap:
    default:
      NeutronTenantNetwork: tenant
      CinderApiNetwork: internal_api
      CinderIscsiNetwork: storage
      GlanceApiNetwork: storage
      GlanceRegistryNetwork: internal_api
      KeystonePublicApiNetwork: internal_api
      NeutronApiNetwork: internal_api
      HeatApiNetwork: internal_api
      NovaApiNetwork: internal_api
      NovaMetadataNetwork: internal_api
      NovaVncProxyNetwork: internal_api
      SwiftMgmtNetwork: storage_mgmt
      SwiftProxyNetwork: storage
      CephClusterNetwork: storage_mgmt
      CephPublicNetwork: storage
      ControllerHostnameResolveNetwork: internal_api
      ComputeHostnameResolveNetwork: internal_api
      BlockStorageHostnameResolveNetwork: internal_api
      ObjectStorageHostnameResolveNetwork: internal_api
      CephStorageHostnameResolveNetwork: storage
    type: json

  # Used in controller in get_attr
  MapNames:
    type: json
    default:
      NetMap: net_ip_map
      ServiceNetMap: service_net_map

resources:

  # Usage of RG
  Controller:
    type: OS::Heat::ResourceGroup
    properties:
    
      count: {get_param: ControllerCount}
      resource_def:
        type: OS::MyTripleO::Controller
        properties:
          # gets value from 07_netipmap.yaml
          ServiceMap: {get_param: ServiceNetMap}
          MapNames: {get_param: MapNames}

  # Usage of ASG
  Compute:
    type: OS::Heat::AutoScalingGroup
    depends_on: Controller
    properties:
      count: {get_param: ComputeCount}
      resource:
        type: OS::TripleO::MyCompute
        properties:
          #Flavor: {get_param: OvercloudComputeFlavor}
          GlanceHost: {get_attr: [Controller, net_ip_map, {get_param: [ServiceNetMap, GlanceApiNetwork]}]}
          #Image: {get_param: NovaImage}
          KeystonePublicApiVirtualIP: {get_attr: [Controller, net_ip_map, {get_param: [ServiceNetMap, KeystonePublicApiNetwork]}]}
          NovaApiHost: {get_attr: [Controller, net_ip_map, {get_param: [ServiceNetMap, NovaApiNetwork]}]}
          NovaPublicIP: {get_attr: [Controller, net_ip_map, external]}
          NetIpMap: {get_attr: [Controller, net_ip_map]}

  
